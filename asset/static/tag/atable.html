<atable>

<style>
.drug_name{
    font-weight:bold;
    font-size:larger;
}
.package{
    font-weight:bold;
}

/* 不採用 */
tr.status0{
    background-color:#CCCCCC;
}
/* 院内 */
tr.status1{
    background-color:#FFAAAA;
}
/* 院外 */
tr.status2{
    background-color:#AAFFAA;
}
/* 院内院外採用 */
tr.status3{
    background-color:white;
}

a,a:visited{
    color:blue;
}

em.saiyou{
    font-weight:bold;

}
em.generic{
    color:red;
    font-style:normal;
    font-size:smaller;
    font-weight:bold;
}

td.コード{
    font-size:smaller;
}
span.成分名{
  font-size:smaller;
}

span.company{
    font-size:smaller;
}


</style>

<div class="info">
下の検索ボックスに薬品名・会社名・YJコードなどを入力して検索してください。
</div>

<span>検索:</span>

<!-- 検索BOX  -->
<input
    id="query_string"
    name="query_string"
    type="text"
    ref="query"
    class="query_input"
    >
</input>
<button onClick="{change}">検索</button>

<input
    id="check_status0"
    type="checkbox"
    name="status0"
    ref="status0"
    onClick="{drug_filter}"
>
不採用
</input>
<input
    id="check_status1"
    type="checkbox"
    name="status1"
    ref="status1"
    onClick="{drug_filter}"
    checked="checked"
>
院内専用
</input>
<input
    id="check_status2"
    type="checkbox"
    name="status2"
    ref="status2"
    onClick="{drug_filter}"
    checked="checked"
>
院外専用
</input>
<input
    id="check_status3"
    type="checkbox"
    name="status3"
    ref="status3"
    onClick="{drug_filter}"
    checked="checked"
>
院内・院外
</input>

<table>
    <thead>
        <th each="{field, index in fields}" class="{field}">
            { field }
        </th>
    </thead>

    <tbody>
            <tr class="status{status_flag}" data-is="drug" each="{drugs}"></tr>
    </tbody>
</table>

    <script>

this.on("mount", function(){
  document.getElementById("query_string").focus()
})


this.all_drugs = []
this.drugs = [ ]

this.fields = [
    "コード",
    "名称",
    "コメント",
    "薬価",
    "リンク",
]


function filter(drugs){
    var new_drugs = []
    var status0 = document.getElementById("check_status0").checked
    var status1 = document.getElementById("check_status1").checked
    var status2 = document.getElementById("check_status2").checked
    var status3 = document.getElementById("check_status3").checked
    drugs.forEach(function(d){
            if(d.status_flag == 0 && status0){
                    new_drugs.push(d)
            }
            if(d.status_flag == 1 && status1){
                    new_drugs.push(d)
            }
            if(d.status_flag == 2 && status2){
                    new_drugs.push(d)
            }
            if(d.status_flag == 3 && status3){
                    new_drugs.push(d)
            }
        }
    )
    return new_drugs
}

drug_filter(e){
    //console.log("drug_filter")
    var tag = this 
    var new_drugs = filter(tag.all_drugs)
    tag.drugs = new_drugs
}

change(e){
    console.log("change")
    var tag = this
    var queryStr = this.refs.query.value
    var url = "/json/available/"
    url += "?query=" + queryStr
    url = encodeURI(url)
    fetch(url)
    .then(function(data){
        return data.json()
    })
    .then(function(json){
        console.log(url)
        //console.debug(json)
        tag.all_drugs = json
        tag.drugs = filter(tag.all_drugs)
        tag.update()
    })
    .then(undefined, function onRejected(error){
        console.log("rejected:" + error)
    })
}

    </script>
</atable>

<drug>
  <td class="コード">
    HOT11:{this["HOT11"]} <br/>
    薬価コード:{this["薬価基準収載医薬品コード"]} <br/>
    YJ:{this["個別医薬品コード"]} <br/>
    薬品コード:{this["drug_code"]} <br/>
    カスタムYJ:{this['custom_yj']} <br/>
  </td>
  <td>
    <em class="saiyou">{this["採用状態"]}</em> 
    <span class="成分名">成分名:{this["成分名"]}</span>
    <div class="drug_name">
    <a 
       href="/redirect/pmda/yj/{ this['個別医薬品コード'] }?from=searchlist"
       target="_blank">{this["販売名"]}
    </a>
    </div>
    <div class="package">
      <!-- {this["後発情報"]} -->
      <em class="generic">{this.kouhatu[ this["後発情報"] ]}</em>
      {this["包装形態"]}
      {this["包装単位数"]}
      {this["包装単位単位"]}
      :
      {this["規格単位"]}
    </div>
    <span class="company">製造:{this["製造会社"]} 販売:{this["販売会社"]}</span>
    <!-- 告示名称:{this["告示名称"]} -->
  </td>
  <td class="center">
    {this["yj_comment"]} {this["hot_comment"]}
  </td>
  <td class="center">
    {this["新_金額"]} 円/ 
    {this["単位_漢字名称"]}
  </td>
  <td class="outerlink">
    <div if={ this['個別医薬品コード'] }>
    <a
      target="_blank"
      href="//10.26.61.131/jiho/latest/CYJ/{this['個別医薬品コード']}.pdf">
          JIHO(薬効)
    </a>
    <a
      target="_blank"
      href="//10.26.61.131/jiho/latest/IYJ/{this['個別医薬品コード']}.pdf">
          JIHO(成分)
    </a>
    <!-- GS1:{ GS1toJAN(this['JAN']) } -->
    <!-- JAN:{ this['JAN'] } -->
    <button onclick="gs1search({ GS1toJAN(this['JAN']) });">GS1での検索結果へ</button>
    </div>
  </td>

<script>

this.kouhatu = {
  "1":"先発(後発なし)",
  "2":"先発(後発あり)",
  "3":"後発",
  "★":"後発(先発と同額以上)",
};


save_status(e){
  console.log("a this:" + Object.keys(this))
  console.log("opts:" + this.opts)
  console.log("opts:" + Object.keys(this.opts))
}
</script>

</drug>
